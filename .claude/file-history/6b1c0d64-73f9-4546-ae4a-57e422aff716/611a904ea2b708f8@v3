<?php

declare(strict_types=1);

namespace App\Http\Controllers\Traits;

use App\Models\BrandProfile;
use App\Models\Conversation;
use App\Models\InfluencerProfile;
use Illuminate\Support\Collection;

trait LoadsInboxConversations
{
    protected function getConversations(BrandProfile|InfluencerProfile $profile): Collection
    {
        $profileType = $profile instanceof InfluencerProfile ? 'influencer' : 'brand';
        $profileIdColumn = $profileType === 'influencer' ? 'influencer_profile_id' : 'brand_profile_id';

        $conversations = Conversation::where($profileIdColumn, $profile->id)
            ->with([
                'brandProfile',
                'influencerProfile',
                'messages' => fn ($query) => $query->latest('sent_at')->limit(1)->with('senderUser'),
            ])
            ->orderBy('last_message_at', 'desc')
            ->get()
            ->map(function ($conversation) use ($profileType) {
                $counterparty = $profileType === 'influencer'
                    ? $conversation->brandProfile
                    : $conversation->influencerProfile;

                $lastMessage = $conversation->messages->first();
                $subtitle = 'No messages yet';

                if ($lastMessage) {
                    $senderUser = $lastMessage->senderUser;
                    $messagePreview = strlen($lastMessage->content) > 50
                        ? substr($lastMessage->content, 0, 50).'...'
                        : $lastMessage->content;
                    $subtitle = ($senderUser?->name ?? 'Unknown').': '.$messagePreview;
                }

                $avatar = null;
                if ($counterparty) {
                    $avatar = $counterparty instanceof \App\Models\BrandProfile
                        ? $counterparty->logo
                        : $counterparty->avatar;
                }

                return [
                    'id' => $conversation->id,
                    'title' => $counterparty?->name ?? 'Unknown',
                    'subtitle' => $subtitle,
                    'avatar' => $avatar,
                    'lastActivityAt' => $conversation->last_message_at?->diffForHumans() ?? 'No activity',
                    'unreadCount' => 0, // TODO: Implement message read tracking
                    'archived' => $conversation->archived,
                    'last_message_at' => $conversation->last_message_at,
                ];
            });

        return $conversations;
    }

    protected function getSystemConversation(BrandProfile|InfluencerProfile $profile): array
    {
        return [
            'id' => 'system',
            'title' => 'Notifications',
            'subtitle' => 'System notifications and updates',
            'lastActivityAt' => $profile->notifications()->latest()->first() ?
                $profile->notifications()->latest()->first()->created_at->diffForHumans() : 'No activity',
            'unreadCount' => $profile->unreadNotifications()
                ->whereIn('type', [
                    \App\Notifications\ReauthenticationRequired::class,
                ])
                ->count(),
            'archived' => false,
            'last_message_at' => $profile->notifications()->latest()->first()?->created_at,
            'is_system' => true,
        ];
    }

    protected function getAllConversations(BrandProfile|InfluencerProfile $profile): Collection
    {
        $systemConversation = $this->getSystemConversation($profile);
        $conversations = $this->getConversations($profile);

        return collect([$systemConversation])->merge($conversations);
    }
}
